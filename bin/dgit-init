#!/bin/bash
SOURCE="$(readlink -f $(dirname $BASH_SOURCE))"
source "$SOURCE/dgit-locations"
list=$(conffolder)

folder=$(zenity --file-selection --title="Choose directory to initialize" --directory)
if [ ! $? -o -z "$folder" ]
then
	exit 0
fi
echo "Folder $folder chosen" &>> "$dgitlog"

#Resolve the folder name to an absolute path
absname=$(readlink --canonicalize-existing --no-newline "$folder")
if [ ! $? ]
then
	echo "Need existing directory!"
exit 1
fi

cd "$absname"

git init &>> "$dgitlog"

ln --symbolic --target-directory "$list" "$absname" &>> "$dgitlog"

#The name of the update script
updatename="dgit-update"

#Copy the update script to the new repo
cp "$SOURCE/$updatename" "$absname/" &>> "$dgitlog"

#Add the update script to git
git add "$updatename" &>> "$dgitlog"

#Commit the update script
git commit -m "Added update to the repo to ensure it comes with every clone" &>> "$dgitlog"

#Make sure everyone can write the repo (for update purposes)
chmod a+w . &>> "$dgitlog"

zenity --info --title="Directory initialized" --text="The selected directory has been initialized."
